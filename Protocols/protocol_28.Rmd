---
author: "Joachim Goedhart"
date: "`r Sys.Date()`"
output: html_document
---

## Protocol 28 - A heatmap of mutations {#protocol-28}

[ThermoMPNN](https%3A%2F%2Fdoi.org%2F10.1073%2Fpnas.2314853121) is a deep neural network that predicts the effect of single amino acid changes on the stability of a protein. A [notebook can be accessed](https://colab.research.google.com/drive/1OcT4eYwzxUFNlHNPk9_5uvxGNMVg3CFA) via google colab to run the predictions and the output is a heatmap, showing the effect of each mutation. The heatmap is generated in the notebook with python code and here I reproduce the plot with ggplot2 as it is a nice example of constructing a heatmap. The data underlying the heatmap can be exported as a CSV file and that is what we are using here to create the plot.

```{r}
library(tidyverse)
```

Let's load the data that is generated by ThermoMPNN for a PDB that is suggested as an example: [PDB 1PGA](https://www.rcsb.org/structure/1PGA)

```{r}
df_mut <- read.csv("data/1PGA.CSV")
head(df_mut)
```

The dataframe contains several columns. Let's change the column name `dd..kcal.mol.` to make it a bit easier to write the code. To this end, we get the column names and replace the third column with `ddG`:

```{r}
#Rename third column
col3 <- colnames(df_mut)[3]
df_mut <- df_mut %>% rename(ddG = col3)
```

Let's do a first attempt at a heatmap for this data with `geom_tile()`, using a custom diverging colorscale that has purple and orange at the extremes and white reflecting zero:

```{r}
ggplot(data = df_mut, aes(pos, mutAA, fill = ddG)) + geom_tile() + 
  scale_fill_gradient2(high = "purple3", mid = "white", low = "orange3") +
  theme_light(base_size = 16)
```

This gives a good impression of the data. Now, let's define an order of amino acids as used in the notebook and that groups the amino acids according to their properties (polar vs. apolar sidechains):

```{r}
custom_order <-  rev(strsplit("QENHDRKTSAGMCLVIWYFP", "")[[1]])
df_mut$mutAA <- factor(df_mut$mutAA, levels = custom_order)
```

In addition to changing the order, we change the legend to the bottom of the figure to make the tiles more square, change the range of the colors, remove the grid, and add a bit of whitespace around each tile:

```{r}

ggplot(data = df_mut, aes(pos, mutAA, fill = ddG)) + geom_tile(colour="white", linewidth = .4) + 
  scale_fill_gradient2(high = "purple3", mid = "white", low = "orange3", limits = range(-2,2)) +
  coord_cartesian(expand = FALSE) +
  theme_light(base_size = 14) +
  theme(legend.position = "bottom", panel.grid = element_blank(), panel.border = element_blank())
```
We see a lot of red boxes, which reflect ddG values that exceed 2. Since these ddG values exceed the extremes, these are treated as `na.value`, as can be visualized by assigning a yellow color to these:

```{r}

ggplot(data = df_mut, aes(pos, mutAA, fill = ddG)) + geom_tile(colour="white", linewidth = .4) + 
  scale_fill_gradient2(high = "purple3", low = "orange3", limits = range(-2,2), na.value = "yellow") +
  coord_cartesian(expand = F) +
  theme_light(base_size = 14) +
  theme(legend.position = "bottom", panel.grid = element_blank(), panel.border = element_blank())
```

This is not cool. Ideally, the out of bounds values should be clipped to the extremes at the ends of the colorscale. To this end we need to load another package {scales} and define in the `scale_fill_gradient2()` function `oob=squish`, defining hwo to treat values that are out-of-bounds (oob). In addition, I like to highlight the wild-type residues and these are indicated by `geom_point()`:


```{r}
library(scales)

p <-  ggplot(data = df_mut, aes(pos, mutAA, fill = ddG)) + geom_tile(colour="white", linewidth = .4) + 
  # geom_tile(aes(pos, wtAA),colour="grey70", fill=NA, linewidth = .4) +
    geom_point(aes(pos, wtAA),colour="grey80", shape=21, fill=NA) +
  scale_fill_gradient2(high = "purple4", low = "orange4", limits = range(-2,2), oob=squish) +
  coord_cartesian(expand = F) +
  theme_light(base_size = 12) +
  theme(legend.position = "bottom", panel.grid = element_blank(), panel.border = element_blank())

p
```

This looks good, and we can finalize it by adding a title and fixing the axis labels:

```{r}
p <- p +
    labs(
    title = "Predicted protein stability",
    caption = "data generated with ThermoMPNN | PDB ID: 1PGA",
    x = "position",
    y = "amino acid",
    tag = "Protocol 28",
    fill = "ΔΔG (kcal/mol) "
  ) +
  theme(plot.caption = element_text(color = "grey80", hjust = 1)) +
  theme(plot.title = element_text(hjust = 0.5, size= 18)) +
  theme(plot.subtitle = element_text(hjust = 0.5, size= 18)
)

p
```

The thing that is a bit annoying is the legend title that is misaligned with the color bar and so I want to fix that:

```{r}
p <- p + theme(legend.title = element_text(vjust = .8))
p
```

Saving the plot:

```{r }
png(file=paste0("Protocol_28.png"), width = 4000, height = 2500, units = "px", res = 600)
 p
dev.off()
```
