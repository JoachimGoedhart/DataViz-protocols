---
author: "Joachim Goedhart"
date: "`r Sys.Date()`"
output: html_document
---

## Protocol 4 - Plotting data from a 96-wells experiment {#protocol-4}

This protocol showcases some serious data wrangling and tidying. One reason is that the data is acquired with a 96-wells plate reader and the data is stored according to the layout of the plate. This makes total sense from a human perspective, but it is not well suited for data visualization.

In addition, the plate is measured twice. One measurement is the luminescence from a luciferase and the other measurement is the luminescence from Renilla. The latter reading serves as a reference and therefore, the luciferase data is divided by the Renilla intensities. A final step before the data is visualized is a normalization to a control condition.

The code that is shown here is also the basis for the [plotXpress app](https://doi.org/10.12688/f1000research.73641.1) that can be used to process and visualize the data. In fact, the data visualization is very close to the standard output of plotXpress and uses the same example data.

We start by loading a package that we need:

```{r }
library(tidyverse)
```

The measured data is read from an excel sheet. Note that this is the raw data that is stored by the software that operates the plate reader:

```{r }
df_raw <- readxl::read_excel("DualLuc_example_data.xlsx", sheet = "Results")
```

The experimental conditions for each well are stored in a separate CSV file, generated by the experimentalist that did the experiment:

```{r }
df_design <- read.csv("Tidy_design.csv")
head(df_design)
```
You can see that the design file is tidy. In contrast the excel file with data is far from tidy. In the excel sheet, two 'rectangles' of cells define the data for the firefly & renilla reads.
The data is subset and converted to a vector

```{r }
firefly <- df_raw[19:26,6:17] %>% unlist(use.names = FALSE)
renilla <- df_raw[40:47,6:17] %>% unlist(use.names = FALSE)
```

Define a dataframe with wells

```{r }
column <- rep(1:12, each=8)
row <- rep(LETTERS[1:8],12)
```

For convenience, all numbers should consist of 2 digits and so we add a zero that precedes the single digit numbers:

```{r }
x0 <- str_pad(column, 2, pad = "0")
```

To generate a unique index for each row in the dataframe, we define 'Wells', which combines the row and column index:

```{r }
Wells <- paste0(row,x0)
```

Next, we create a dataframe that holds the data of individual columns, rows and wells:

```{r }
df_plate <- data.frame(column,row,Wells)
head(df_plate)
```

Add to df_plate the vectors with data from firefly and renilla reads

```{r }
df_4 <- data.frame(df_plate,firefly,renilla)
```

Merge the design with the data, based on the well ID - left_join() is used to add only data for wells that are listed in the design dataframe

```{r }
df_4 <- left_join(df_design, df_4, by='Wells')
head(df_4)
```

Calculate the relative expression from the firefly/renilla ratio

```{r }
df_4 <- df_4 %>% mutate(expression=firefly/renilla)
```

Take all control conditions and calculate the average value

```{r }
df_norm <- df_4 %>% filter(condition == "-") %>%
  group_by(treatment1,treatment2) %>%
  summarise(mean=mean(expression)) 
```

Combine the mean values (needed for normalization) values with the df_4 dataframe

```{r }
df_4 <- df_4 %>%
  full_join(df_norm, by=c("treatment1","treatment2")) %>%
  na.omit(condition)
```

Calculate the `Fold Change` by normalizing all measurements against the control (-)

```{r }
df_4 <- df_4 %>% mutate(`Fold Change` = expression/mean)
```

The result is a dataframe that holds all the necessary data:
```{r}
head(df_4)
```

The data is in the right shape now, so let's save it:

```{r}
df_4 %>% write.csv("protocol_4.csv", row.names = FALSE)
```

Based on the dataframe, we can create a plot with jittered dots that show the data:

```{r }
p <- ggplot(df_4, aes(x=condition, y=`Fold Change`)) +
  geom_jitter(width = 0.2, alpha=0.5, size=3)
```

To splot the graphs based on treatment1 (vertical) and treatment2 (horizontal) we use the `facet_grid()` function:

```{r }
p <- p + facet_grid(treatment1~treatment2)
```

We add a horizontal line for mean value:

```{r }
p <- p + stat_summary(fun.min=mean, fun.max=mean, geom='errorbar', width=0.6, size=0.5)
```

Add labels:

```{r }
p <-
  p + labs(
    title = "Effect of DNA sequences on reporter levels under different conditions",
    subtitle = "The expression level was determined by a dual luciferase assay\n and the values were normalized to a control with no DNA sequence (-)",
    x = "DNA Sequence",
    y = "Fold change of the reporter relative to the control (-)",
    caption = "@joachimgoedhart\n(based on data from Brandorff et al., DOI: 10.1101/2021.07.08.451595)",
    tag = "Protocol 4"
  ) 
```

Set the theme and font size:

```{r }
p <- p + theme_light(base_size = 14)
```

Format the facet labels (strips) and the caption + subtitle

```{r }
p <- p + theme(strip.background = element_rect(fill="grey90", color="grey50"),
               strip.text = element_text(color="grey50"),
               plot.caption = element_text(color = "grey80"),
               plot.subtitle = element_text(color = "grey50", face = "italic"),
               #Remove the grid
               panel.grid.major = element_blank(),
               panel.grid.minor = element_blank()
)
```

Let's look at the result:

```{r }
p
```

To save the plot as a png file:

```{r }
png(file=paste0("Protocol_04.png"), width = 4000, height = 3000, units = "px", res = 400)
 p
dev.off()
```

