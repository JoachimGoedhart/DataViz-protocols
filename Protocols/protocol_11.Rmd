---
author: "Joachim Goedhart"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Protocol 11 - Plotting time data from a Google form {#protocol-11}

The goal of this script is to read data that was generated by a Google form and visualize the distribution of the hours at which the form was submitted. We need the tidyverse package:

```{r }
library(tidyverse)
```

The data from the Google form are stored in a sheet that was published on the web as a CSV. This was achieved by 'File > Share > Publish to web' and selecting to 'Publish' as 'Comma-separated values'.
After clicking on 'Publish' a link is generated that can be read as a csv. Any empty cells are converted to `NA`. As explained in protocol 10, we will load a snapshot of the sheet (the code to read the actual sheet is outcommented here):

```{r}
# df_sheet <- read.csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSc-nI1-s_u-XkNXEn_u2l6wkBafxJMHQ_Cd3kStrnToh7kawqjQU3y2l_1riLigKRkIqlNOqPrgkdW/pub?output=csv", na.strings = "")

df_sheet <-  read.csv("20220421_Resultaat-metingen.csv", na.strings = "")
head(df_sheet)
```

Here, we are only interested in the first column with the time data. So we select that column and replace the dutch column name by 'Timestamp':

```{r}
df_sheet <- df_sheet %>% dplyr::select("Timestamp"=1) %>% na.omit()
```

We can seperate the Timestamp column in date and time:
```{r}
df_tidy <- df_sheet %>% separate('Timestamp', c("Date", "Time"), sep=" ")
```

Correct handling of date and time data is quite challenging and a topic on its own. The code to format the  'Date' column as date (note that we need a capital `Y` as the year is presented in 4 digits) would be:

```{r}
df_tidy %>%
  mutate(Date=as.Date(Date, "%d/%m/%Y")) %>% head()
```

Here, we avoid the `Date` format and use the individual numbers. The 'Date' column is seperated into three columns for year, month and day. The 'Time' column can be split into hour, minute and second:

```{r}
df_tidy <-  df_tidy %>%
  separate('Date', c("day", "month", "year"), sep="/", convert = TRUE) %>%
  separate('Time', c("hour", "min", "sec"), sep=":", convert = TRUE)
head(df_tidy)
```

Note that we use `convert = TRUE` to ensure that the data is treated as numbers (not as characters). We can use the data to check at what time the data was submitted:

```{r}
ggplot(df_tidy, aes(x=hour))+geom_histogram(alpha=.8)
```

The default number of 'bins' is 30, but it makes more sense to use 24 here as there are 24 hours in a day:

```{r}
ggplot(df_tidy, aes(x=hour))+geom_histogram(bins = 24, alpha=.8)
```
Since 'hour' is a number that cycles, with 0 followed by 23, it is nice to connect the data from 23 with 0 and we can do that with `coord_polar()`:

```{r}
ggplot(df_tidy, aes(x=hour)) + 
  geom_histogram(bins = 24, alpha=.8) +
  coord_polar() + 
  scale_x_continuous(breaks=seq(0, 24, by=2))
```

To center the plot at 0, we need to rotate it by -7.5 degrees (1 hour equal 15 degrees). We can use the `start` option within `coord_polar()`, but it only accepts 'radians'. To convert degrees to radians the value is multiplied by pi/180:

```{r}
ggplot(df_tidy, aes(x=hour)) + 
  geom_histogram(bins = 24, alpha=.8) +
  coord_polar(start = (-7.5*pi/180)) + 
  scale_x_continuous(breaks=seq(0, 24, by=3))
```
The plot can be rotated to center it around 15h as it reflects the middle of the afternoon, when most activity takes place. To achieve this, we need to shift the start another 15*15 degrees:

```{r}
p <- ggplot(df_tidy, aes(x=hour)) + 
        geom_histogram(bins = 24, alpha=.8, color='black') +
        coord_polar(start = (-7.5 - 15*15)*pi/180) + 
        scale_x_continuous(breaks=seq(0, 24, by=3))
p
```
This looks good, let's first improve on the layout by changing the theme. I do not like the grey background, so any theme with a white background is an improvement, for instance `theme_minimal()`:


```{r}
p + theme_minimal()
```

I do not like the labels that show the count. Since it is clear that the length of the bar indicates an amount and since the absolute amount is not so interesting, these labels can be removed. The labels for the hours are helpful and their sice needs to be increased. Finally, I do not like the grid running through the numbers. I did not find a way in the theme setting to get rid of this, so we define the grid ourselves by using repetitive horizontal and vertical lines:

```{r}
p <- p +
  geom_hline(yintercept = c(2,4,6,8), colour = "grey90", size = 0.5) + 
  geom_vline(xintercept = seq(0, 21, by=3), colour = "grey90", size = 0.5) +
  
  theme_minimal(base_size = 16) +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        axis.text.y = element_blank()
  )
p
```

The grid looks good, but the bars have to be on top of this layer, so we redefine the plot in the correct order:


```{r}
p <- ggplot(df_tidy, aes(x=hour)) +
  geom_hline(yintercept = c(2,4,6,8), colour = "grey90", size = 0.5) + 
  geom_vline(xintercept = seq(0, 21, by=3), colour = "grey90", size = 0.5) +
  geom_histogram(bins = 24, alpha=.8, color='black') +
  coord_polar(start = (-7.5 - 15*15)*pi/180) + 
  scale_x_continuous(breaks=seq(0, 24, by=3)) +
  theme_minimal(base_size = 16) +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        axis.text.y = element_blank()
  ) +
  labs(
    title = "Counting the hours...",
    subtitle = "that a Google form was submitted",
    x = "",
    y = "",
    caption = "@joachimgoedhart | data submitted by students",
    tag = "Protocol 11"
  ) +
  theme(plot.caption = element_text(color = "grey80", hjust = 1))
  
p
```

A centered title and subtitle looks nice on this plot:
```{r}
p <- p + theme(
        plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5)
)
p
```



To save the plot as a PNG file:
```{r }
png(file=paste0("Protocol_11.png"), width = 4000, height = 3000, units = "px", res = 400)
  p
dev.off()
```



