---
author: "Joachim Goedhart"
date: "`r Sys.Date()`"
output: html_document
---

## Protocol 10 - Plotting data that was harvestd with a Google form {#protocol-10}

The goal of this script is to read data that was generated by a Google form, transform it into a tidy format and plot the data. The form contains data that is submitted by students after doing a course on cell biology. The data that is submitted are length measurements on cells and in the end, we will plot these date.


First, we need the `{tidyverse}` package:

```{r }
library(tidyverse)
```

The data from the Google form are stored in a Google sheet that was published on the web as a CSV. This was achieved by 'File > Share > Publish to web' and selecting to 'Publish' as 'Comma-separated values'.
After clicking on 'Publish' a link is generated that can be read as a csv, and any empty cells are converted to `NA`. Below is the _outcommented_ code that loads the online google sheet. To make sure that this script works even when the google sheet is no longer active and to ensure a reproducible data visualization, I downloaded a snapshot (made on 21st of April, 2022) of the google sheet as a csv file and I'll load that insetad: 

```{r}
# df_sheet <- read.csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSc-nI1-s_u-XkNXEn_u2l6wkBafxJMHQ_Cd3kStrnToh7kawqjQU3y2l_1riLigKRkIqlNOqPrgkdW/pub?output=csv", na.strings = "")

df_sheet <-  read.csv("data/20220421_Resultaat-metingen.csv", na.strings = "")

head(df_sheet)
```

There are a number of issues with this data. The first 5 rows are empty. I deleted the values in these rows, since they were dummy values from testing the form. Let's remove rows without data:

```{r}
df_sheet <- df_sheet %>% na.omit()
```

The header names are still in the original language (Dutch) and the third and fourth header names with the relevant data are very long. Let's change the names:

```{r}
colnames(df_sheet) <- c("Timestamp", "Group", "Cell", "Nucleus")
```

All the length measurements are distributed over two columns, let's make it tidy and move it to one column:

```{r }
df_tidy <-
  pivot_longer(
    df_sheet,
    cols = -c("Timestamp", "Group"),
    names_to = "Sample",
    values_to = "Size"
  )
head(df_tidy)
```

The column with measurements contains up to 10 length measurements. The values are separated by a comma and often a space. First, the space is removed and then each row is split into multiple rows, where each row has a single measurement. The comma is used to separate the values:

```{r}
df_tidy <- df_tidy %>% mutate(Size = gsub(" ", "", Size)) %>% separate_rows(Size, sep=",") 
```

The 'Size' column values are converted to the class numeric. The advantage is that anything that is not a number will be converted to `NA`. These non-numeric data can stem from incorrectly enetered data. Examples of these incorrect data are numbers with units or with wrong separators.

```{r}
df_tidy <- df_tidy %>% mutate(Size = as.numeric(Size))
```

Finally, we can filter any values that fall outside the range of expected values (and this will also remove the cells with `NA`):

```{r}
df_size <- df_tidy %>% filter(Size>0 & Size<1000)
head(df_size)
```

The dataframe is cleaned and tidy and so it is ready for visualization. The primary information is the distribution of size measurements for the measurements of cells and cell nuclei. This can be achieved by using `geom_density()`. Given the range of sizes, it makes sense to use a log10 scale for the x-axis:

```{r}
ggplot(df_size, aes(x=Size, fill=Sample))+geom_density(alpha=.8) +
  scale_x_log10()
```

The `geom_density()` produces a smooth distribution of the data. I actually prefer to see the real data and that's why we turn to `geom_histogram`. I also will split the data according to the sample and groups and this can be achieved with `facet_grid()`. Here, we use the `labeller()` function to combine the column name 'Group' with the the factor it presents, as this makes it easier to understand what is plotted:

```{r}
ggplot(df_size, aes(x=Size, fill=Sample))+geom_histogram(alpha=.8) +
  facet_grid(Sample~Group, labeller = labeller(Group=label_both)) +
  scale_x_log10()
```

The use of color is redundant, since the data is split in Cell and Nucleus anyway, so we remove that. The difference between groups is not large and for the final data visualization I chose to combine the data for all the groups: 

```{r}
p <- ggplot(df_size, aes(x=Size)) +
  geom_histogram(alpha=.5, bins=50) +
  facet_grid(~Sample) +
  annotation_logticks(sides="b", outside = TRUE) +
  scale_x_log10()
p
```

The data is presented in a nice way now, and we can improve the axis labels and add a title and caption:

```{r }
p <-
  p + labs(
    title = "Distribution of size measurements",
    subtitle = "Sizes of human cells and nuclei of cells",
    x = "Size [Âµm] - log scale",
    y = "Count",
    caption = "@joachimgoedhart | data submitted by 4 groups of students",
    tag = "Protocol 10"
  )
```

Optimizing the layout:

```{r }
p <-
  #Set text size
  p + theme_light(base_size = 16) +
  # Change the color and position of the caption
  theme(
    plot.caption = element_text(
      color = "grey80",
      hjust = 1
    )
  )
p
```

This looks very decent. But we can edit change the x-axis to display logarithmic space ticks. In addition, I'd like the bars of the histogram to start from the axis and not 'float' as in the graph above:

```{r}
p <- p +
  #Force the y-axis to start at zero
  scale_y_continuous(expand = c(0, NA), limits = c(0,200)) +
  #Apply a logarithmic scale to the x-axis and set the numbers for the scale
  scale_x_log10(breaks = c(1,10,100), limits = c(.5,200)) +
  #Remove minor gridlines
  theme(panel.grid.minor = element_blank()) +
  #Add ticks to the bottom, outside
  annotation_logticks(sides="b", outside = TRUE) +
  #Give a little more space to the log-ticks by adding margin to the top of the x-axis text
  theme(axis.text.x = element_text(margin = margin(t=8))) +
  #Needed to see the tcks outside the plot panel
  coord_cartesian(clip = "off")
p
```


To save the plot as a PNG file:
```{r }
png(file=paste0("Protocol_10.png"), width = 3000, height = 2000, units = "px", res = 400)
  p
dev.off()
```


